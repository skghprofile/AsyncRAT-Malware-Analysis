# AsyncRAT Malware Analysis

### Table Of Contents

- [AsyncRAT Malware Analysis](#asyncrat-malware-analysis)
  - [Table Of Contents](#table-of-contents)
  - [Introduction](#introduction)
  - [Infection methods](#infection-methods)
  - [Infection Analysis Walkthrough](#infection-analysis-walkthrough)
    - [First Process](#first-process)
    - [Second Process](#second-process)
    - [Third and Fourth Process](#third-and-fourth-process)
    - [Fifth Process](#fifth-process)
    - [Sixth Process](#sixth-process)
    - [IOCs](#iocs)
    - [Protecting/Defending against AsyncRAT](#protectingdefending-against-asyncrat)
- [Acknowledgments](#acknowledgments)

## Introduction

The AsyncRAT is a type of malware that acts as a remote access trojan, which allows attackers to monitor and control a target's computer through a secure encrypted connection.

From [Blackberry's wesbite](https://www.blackberry.com/us/en/solutions/endpoint-security/ransomware-protection/asyncrat), some of its malicious functions include:

- Remotely record a target's screen
- Log and exfiltrate keystrokes
- Import and execute additional malware
- Exfiltrate files on an infected system
- Maintain persistence and remotely reboot infected systems
- Disable the processes of IT security products
- Launch botnet-enabled DOS attacks on internet-accessible targets

The AsyncRAT was originally developed as an open source, legitimate remote access tool on [GitHub](https://github.com/NYAN-x-CAT/AsyncRAT-C-Sharp) with its first release dated September 15th, 2019. Since then, malicious actors have altered the AsyncRAT source code to create malicious remote access trojans, and now is one of the most popular types of malware used in 2024.

## Infection methods

The AsyncRAT is usually shared through spam email campaigns as an attachment and can be found through infected ads on compromised websites. Malicious actors have also used the AsyncRAT to be added to an infected endpoint once the initial malware is successfully running.

## Infection Analysis Walkthrough

Looking at different samples that were publically submitted on [any.run submissions tab](https://app.any.run/submissions/#tag:asyncrat), various file types contain the AsyncRAT malware. The main file types I see from the submissions are in the form of a .exe executable, either by itself or included in a .zip or .rar archive, or in the form of a .doc that uses macros to download itself onto the computer once opened with macros enabled.

![AsyncRAT any.run public submission page](/Images/AR-img01.PNG)

For this walkthrough, I will use the AsyncRAT file submission from [Any.run's AsyncRAT writeup](https://app.any.run/tasks/5774506f-cb9b-4933-83c8-11cff68c0b9c/?utm_source=mtt&utm_medium=article&utm_campaign=asyncrat&utm_content=task/)

![AsyncRAT any.run sandbox](/Images/AR-img02.PNG)

This specific AsyncRAT sample:

- Uses the filename: payment details.doc
- Has an MD5 hash of: a3ac96a5b997a546855538e67072fcf1
- Ran on Any.run's sandbox on Februrary 11th, 2022
- Infects the computer through the use of macros being enabled through Microsoft Word

Once the file is opened with Microsoft Word with macros enabled, the malicious payment details.doc follows this process tree:

![AsyncRAT any.run process tree](/Images/AR-img03.PNG)
![AsyncRAT any.run process graph](/Images/AR-img04.PNG)

### First Process

The first process written to the disc or "dropped" upon opening the malicious document with macros enabled is:

- Process ID: 2236
- Application Name: WindowsMicrosoftvixenupdate.exe
- Application Location: C:\Users\admin\AppData\Local\Temp\WindowsMicrosoftvixenupdate.exe
- Application Description: CarRaceGame

![AsyncRAT process](/Images/AR-img05.PNG)

Further analysis shows that this process does a couple of things:

- The application launches itself
- Checks LSA (Local Security Authority) protection
- Reads the machine GUID from the registry
- Reads the computer name
- Checks supported languages

![AsyncRAT process](/Images/AR-img06.PNG)

### Second Process

The second process in the tree has the same executable name as the first "WindowsMicrosoftvixenupdate.exe", but this process does more actions than the first. It creates a registry key in the startup folder for persistence and creates a temporary .bat file to be launched and run by CMD.

![AsyncRAT process](/Images/AR-img07.PNG)

This process creates the .bat file: "C:\Users\admin\AppData\Local\Temp\tmp79A0.tmp.bat" in a temporary directory and also creates the RAT file: "C:\Users\admin\AppData\Roaming\Wind0wsDrivers.exe" in another temporary directory.

### Third and Fourth Process

The third and fourth processes involve the Windows Command Prompt (CMD.exe) launched from the previous executable "WindowsMicrosoftvixenupdate.exe". The executable runs the following commands in the command prompt: C:\Windows\system32\cmd.exe /c ""C:\Users\admin\AppData\Local\Temp\tmp79A0.tmp.bat". This command executes the .bat file in the temporary directory and closes the command prompt process afterward. The command prompt doesn't immediately close since the fourth process executes the command "timeout 3" which causes a delay in the command prompt for three seconds.

![Any.run process analysis](/Images/AR-img08.PNG)
![Any.run process analysis](/Images/AR-img09.PNG)

### Fifth Process

The fifth process seems to act similarly to the first process but with a different application name, "Wind0wsDrivers.exe". Now that the malware is able to infect the computer, bypass its security, and establish persistence, the next process is where the malicious RAT starts running.

![Any.run process analysis](/Images/AR-img10.PNG)

### Sixth Process

The final process in this sandbox analysis within this Any.run sample of the AsyncRAT is where the RAT is executed, connects to C2 servers, and runs in the background.

![Any.run process analysis](/Images/AR-img11.PNG)

From Any.run's analysis, I can view the malware's configuration:

```
{
 "C2": [
 "127.0.0.1",
 "194.5.97.41"
 ],
 "Ports": [
 "6606",
 "7707",
 "8808",
 "5200"
 ],
 "Version": "0.5.7B",
 "Autorun": "true",
 "Mutex": "AsyncMutex_6SI8OkPnk",
 "Certificate": "MIIE8jCCAtqgAwIBAgIQAMp9zmWIjfClrYFk5X0y6zANBgkqhkiG9w0BAQ0FADAaMRgwFgYDVQQDDA9Bc3luY1JBVCBTZXJ2ZXIwIBcNMjIwNTIzMDgwNTQ3WhgPOTk5OTEyMzEyMzU5NTlaMBoxGDAWBgNVBAMMD0FzeW5jUkFUIFNlcnZlcjCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBALwJtTezxCnK9ylBGoOYYQY+27rf8DN3TQLIiGSZ462LTqBnBp1NK0gW36PUQ8LWcilxxdxITyC...,
 "Server_Signature": "lzI4ahp3j/leR9hV5f/0hhc1qmIkSYuj/5bkr2Kbzkjjt8vP5H0m+vWlwPsVLT7rZmLgh5tMfZOL8Yrt+l7eDbax6y7syNxe97jeyn4vHQpoCYMKz7NQCchMeyI+uTa+8Es2jdluIdxU2q/yugKB0F/8A+nZxWsTfTMrjbD4wY78/gNl0kdlcgJwVPtIPvy1R+x3OKDaTggtjWLdmPl3vb5AuAVI7AjjU/r5Y36MWUHEL25CU/tVq3RJ8zar3d3ojU9gxa48UvEJw+AERUKCJNdIkRI6fl5WKf0odTSPJ3E...,
 "AntiVM": "false",
 "PasteBin": "null",
 "bdos": "false",
 "Botnet": "SIGRA",
 "Aes_Key": "f5449a9402df7c0576ccd172f9daca0bdc619cb2b7ba8c66332cb8e50f6f88a1",
 "Salt": "bfeb1e56fbcd973bb219022430a57843003d5644d21e62b9d4f180e7e6c33941",
 "Install_Folder": "%AppData%"
}
```

![Any.run malware configuration window](/Images/AR-img12.PNG)

In this configuration window, I can see many important aspects of this specific sample of the AsyncRAT:

- The C2 (Command & Control) IPs that it receives commands/instructions from are:
  - 127.0.0.1
  - 194.5.97.41

I found it interesting that alongside the foreign IP address "194.5.97.41", the RAT also uses the localhost/loopback address "127.0.0.1". The inclusion of the 127.0.0.1 address could be related to an error or misconfiguration by whoever configured this specific sample of the RAT or even trying to use the address to possibly avoid detection by antivirus or EDR software.

- The ports used to send/receive internet traffic are:

  - 6606
  - 7707
  - 8808
  - 5200

- The version of the RAT:

  - 0.5.7B

- Its specific mutex:

  - AsyncMutex_6SI8OkPnk

- Botnet Family:
  - SIGRA

### IOCs

Since AsyncRAT has been around since 2019, with malicious actors configuring it with their own C2 servers and spreading through various ways, many IOCs (Indicators of Compromise) are associated with this family of malware.

From Any.run's malware trends analysis page for AsyncRAT, they have a list compiled of IOCs to look out for:

![AsyncRAT IOCs](/Images/AR-img13.PNG)

From the specific sample of the AsyncRAT analyzed above, the IOCs I found are as follows:

- IP Addresses:
  - 194.5.97.41

![AsyncRAT malicious connections](/Images/AR-img14.PNG)

- SHA-1 Malicious Hashes:

  - a3ac96a5b997a546855538e67072fcf1
  - d16e9f9f6aa40d6b1867d80511d85c6e66a50f71

- Executable Names:

  - WindowsMicrosoftvixenupdate.exe
  - Wind0wsDrivers.exe

- Writing to Registry:
  - Autorun Value
  - Operation: Write
  - Name: WIND0WSDRIVERS
  - Value: "C:\Users\admin\AppData\Roaming\Wind0wsDrivers.exe"
  - Key: HKEY_CURRENT_USER\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUN
  - TypeValue: REG_SZ

### Protecting/Defending against AsyncRAT

After analyzing this sample of the AsyncRAT and the steps it takes to infect a target computer, I noticed various ways to protect against the initial infection or mitigate the complete infection of the target computer.

Since this specific sample was initialized through a .doc document with malicious macros, the initial infection of the computer could be prevented in a couple of ways with adequate user training. If this .doc was initially part of an email campaign, end users could/should be trained on how to spot an illegitimate email and not to download any attachments from those emails.

Suppose an end user downloads the attachment. In that case, they should also be educated/trained on the risks associated with.doc files in general. They should only enable macros in Microsoft Word if they know exactly what the macros will do and that the person who sent the document can be verified and trusted.

Alongside user education/training, there are also settings within Microsoft Word that should be configured and verified they are enabled.

Within Microsoft Word's settings menu, inside the Trust Center, settings under the menus "Macro Settings" and "Protected View" should be configured correctly and verified they are enabled.

Under the "Macro Settings" menu, I would recommend the radio button "Disable all macros without notification" selected for regular end users since they won't be tempted to click the "Enable Macros" on a macro-enabled document when it's opened.

![Macro Settings Microsoft Word](/Images/AR-img15.PNG)

Under the "Protected View" menu, I would ensure that all checkboxes are enabled to open potentially dangerous document files in a restricted mode. Hence, nothing malicious happens if a user accidentally/unknowingly opens a potentially malicious document.

![Protected View Microsoft Word](/Images/AR-img16.PNG)

These settings can also be set within a GPO through the path: User Configuration > Administrative Templates > Microsoft Word 20xx > Word Options > Security > Trust Center.

Suppose all else fails above, alongside the computer's antivirus or EDR solution not quarantining the malicious .doc when initially opened, and the macros are successfully run. In that case, the next step in the infection process is set in motion. From the Any.run analysis, the .doc drops a malicious executable in a temporary directory "C:\Users\admin\AppData\Local\Temp\WindowsMicrosoftvixenupdate.exe" and launches it.

From here, there are a couple of different ways the execution of the executable can be blocked if not quarantined by an antivirus or EDR solution.

- The most strict implementation could be an application whitelist where only specific applications can run on an end user's computer while blocking anything else.
- Another way could be to use Applocker. Within Applocker, policies could be set up where only digitally signed applications can be run or even block the execution of applications from temporary folders since that's where the malicious executable in this sample resides.

The next step in the infection process, if the above fails, is establishing persistence and opening a CMD terminal to run commands.

- The ability for a user to have access to the Windows registry can be disabled through GPO with the path: User Configuration > Administrative Templates > System > Prevent access to registry editing tools, but malicious applications could bypass this setting.
- Similarly, access to the Windows Command Prompt can be blocked via GPO with the path: User Configuration > Administrative Templates > System > Prevent access to the command prompt.
- Also, the Windows Command Prompt can be disabled to be run from executable files in temporary directories through Software Restriction Policies in Group Policy through the path: Computer Configuration > Windows Settings > Security Settings > Software Restriction Policies, adding an additional rule with the paths to temporary directories "C:\Windows\Temp\*.exe" and "%USERPROFILE%\AppData\Local\Temp\*.exe".

Next in the infection process is using cmd.exe to run a .bat file within the temporary directory. The successful execution of the .bat can be blocked with AppLocker. Through applocker, rules can be set up to disable the execution of .bat files within specific directories, such as the temporary directory in the Any.run sample "C:\Users\admin\AppData\Local\Temp\tmp79A0.tmp.bat" or even disable the execution of all .bat files if they aren't digitally signed.

The last part of the RAT's infection process is the execution of the RAT "Wind0wsDrivers.exe" at the location "C:\Users\admin\AppData\Roaming\Wind0wsDrivers.exe". Like above, the successful execution of the program could be blocked through an antivirus or EDR solution,  application whitelisting, or even AppLocker, but assuming the worst, the AsyncRAT is now successfully running on the end user's computer.

Since this AsyncRAT needs to connect to the attacker through the internet to receive/send actions/commands, the connection between the attacker and victim can be blocked. The AsyncRAT sample used in this analysis connects to the C2's IP "194.5.97.41" located in the Isle of Man. The RAT also connects to the C2's IP using non-standard ports: 8808 and 5200. Firewalls should be configured to only allow traffic to flow through only necessary ports. Since no regular services should be running on ports 8808 and 5200, these ports should be blocked. Blocking these ports would ultimately block the send/receive traffic to the C2's IP. Firewalls can also be configured to block traffic to certain geographical regions. If the end user or any other end users on the network don't need to communicate with any networks in the Isle of Man, those range of IPs can be blocked; therefore, the RAT couldn't communicate with the C2 located there.

# Acknowledgments

- [Any.run](https://any.run/) For their sandboxing platform and ability to analyze file samples for malicious IOCs.
- [Any.run AsyncRAT writeup](https://any.run/malware-trends/asyncrat) For detailed research and analysis of the AsyncRAT malware.
